# win-file-agent

Агент для обработки файлов сторонними Windows-утилитами командной строки. HTTP-сервер с REST API, управление очередью задач, установка как Windows-служба.

## Сборка сервиса ##
  Для сборки сервиса в linux надо выполнить команду make build
  Для сборки сревиса для windows надо выплнить команду make build-windows

## Статические анализ кода ##
  Для запуска анализа кода надо выполнить make analysis

## Установка сервис в среде windows ##
  1. Собрать проект через команду make build-windows
  2. Скопировать win-file-agent.exe в созданную FileAgent папку по пути C:\Program Files\FileAgent
  3. Открыть windows cmd, нажмите клавишу Windows (или нажмите на лупу), введите cmd и нажмите Enter. Чтобы запустить от имени администратора, нажмите правой кнопкой мыши на "Командная строка" -> "Запуск от имени администратора".
  4. Перейти в папку с сервисом cd C:\Program Files\FileAgent
  5. Вставить команду win-file-agent.exe install
  6. Открыть администрирование сервисов
  7. Найти по имени файла новый установленный сервис
  8. Настроить в нем автозапуск и запустить
  9. Для удаления запустить команду win-file-agent.exe remove

## Дополнительная настройка сервиса ##
### Настройка порта сервиса, кол-ва воркеров и длинну очереди для параллельной обработки команд
  1. Создаем файл config.json в папке с исполняемым файлом .exe, формат:
    {
      "port": 8080,
      "worker_count": 4,
      "worker_queue": 10,
      "tmp_dir": "C:\tmp"
    }
  2. Устанавливаем новый порт, кол-во workers, длинну очереди, опционально временную папку для ftp данных и сохраняем
  3. Открываем администрирование сервисов
  4. Находим по имени файла установленный сервис
  5. Нажимаем на кнопку перезапуска сервиса для применения изменений
  6. В логе сервиса повится записть "Загружен конфиг: {Port:8080 WorkerCount:4 WorkerQueue:10}"

## Описание сервиса
  * Get, "/v1/task" - получение списка ключей всех заданий в работе, ответ в виде ["qwe", "rty"]
  * Post, "/v1/task" - создание задания на обработку. json запроса имеет вид {"in_dir":"in","out_dir":"out","urls":[""],"cmd":"cmd","args":["{input}","{output}"],"out_ext":"mp4","ftp":{"addr":"addr","login":"login","pass":"pass"}}, где:
    - in_dir - папка, в ее скачиваются файлы
    - out_dir - папка для сборка результата
    - urls - список urls откуда качать файлы
    - cmd - команда запуска обработки
    - args - аргументы запуска команды
    - out_ext - расщирение выходного файла, если нужно
    - {input} - константа для автозамены на имя входящего файла
    - {output} - константа для автозамены на имя исходящего файла 
    - ftp.addr - адрес ftp сервера. Формат addr:port. Порт обязательно указывать, по умолчанию 21
    - ftp.login - логин для ftp 
    - ftp.pass - пароль для ftp
    Возвращает id нового задания dbe244bb99ee51889c2d6c129fdd0689921db052937b802ba6f61f0867e5de10 с http статусом 201
  * Get, "/v1/task/{id}" - получение задание и его статус. {id} - ключ задания. Ответ в виде {"id":"011a03da17d8a583320edf64779b9466bab762a19850c9a5f2928f4fdc196498","in_dir":"in","out_dir":"out","urls":[""],"cmd":"cmd","args":["{input}","{output}"],"out_ext":"mp4","files":[""],"state":0,"msg":"msg"}, где:
    - повторяет данные с in_dir по out_ext из Post, "/v1/task"
    - files - файл лежащие в папке in_dir
    - state - состояние задания
    - msg - если задание в состонии ERROR, то заполнено ошибкой
  * Delete, "/v1/task/{id}" отмена задания. {id} - ключ задания

  * Если задание имеет статус завершено или ошибка, то оно висит в сервисе еще 1 минуту.
  * Если задание упало в ошибку, то саму ошибку можно получить при запросе Get, "/v1/task/{id}", поле Msg
  * Ключи формируются на основе хеша стурктуры. Если делать один и тот же запрос, то будет ошибка 409
  * Список состояний:
    - CREATE   - 0 создано задание
    - DOWNLOAD - 1 загрузка файлов
    - PROCESS  - 2 процесс обработки в cmd
    - CANCEL   - 3 отмена обработки задания
    - FINISH   - 4 обработка задания завершена
    - ERROR    - 127 Ошибка при обработке задания
  * Если место на диске меньше 1гб, то сервис будет выдавать ошибку 507 Insufficient Storage («переполнение хранилища»);
