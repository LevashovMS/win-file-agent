# win-file-agent

Агент для обработки файлов сторонними Windows-утилитами командной строки. HTTP-сервер с REST API, управление очередью задач, установка как Windows-служба.

## Сборка сервиса ##
  Для сборки сервиса в linux надо выполнить команду make build
  Для сборки сревиса для windows надо выплнить команду make build-windows

## Статические анализ кода ##
  Для запуска анализа кода надо выполнить make analysis

## Установка сервис в среде windows ##
  1. Собрать проект через команду make build-windows
  2. Скопировать win-file-agent.exe в папку 
  3. Открыть windows cmd (ctrl+shift+p)
  4. Вставить команду и запусть
  5. Открыть администрирование сервисов
  6. Найти по имени файла новый установленный сервис
  7. Настроить в нем автозапуск и запуск

## Дополнительная настройка сервиса ##
### Настройка порта сервиса и кол-ва воркеров для параллельной обработки команд
  1. Создаем файл config.json в папке с исполняемым файлом .exe, формат:
    {
      "port": 8080,
      "worker_count": 4
    }
  2. Устанавливаем новый порт или кол-во workers и сохраняем
  3. Открываем администрирование сервисов
  4. Находим по имени файла установленный сервис
  5. Нажимаем на кнопку перезапуска сервиса для применения изменений
  6. В логе сервиса повится записть "Загружен конфиг: {Port:8080 WorkerCount:4}"

## Описание сервиса
  * Get, "/v1/task" - получение списка ключей всех заданий в работе
  * Get, "/v1/task/{id}" - получение задание и его статус. {id} - ключ задания
  * Post, "/v1/task" - создание задания на обработку. json запроса имеет вид {"in_dir":"in","out_dir":"out","urls":[""],"cmd":"cmd","args":["{input}","{output}"],"out_ext":"mp4"}, где:
    - in_dir - папка, в ее скачиваются файлы
    - out_dir - папка для сборка результата
    - urls - список urls откуда качать файлы
    - cmd - команда запуска обработки
    - args - аргументы запуска команды
    - out_ext - расщирение выходного файла, если нужно
    - {input} - константа для автозамены на имя входящего файла
    - {output} - константа для автозамены на имя исходящего файла 
  * Delete, "/v1/task/{id}" отмена задания. {id} - ключ задания

  * Если задание имеет статус завершено или ошибка, то оно висит в сервисе еще 2 минут.
  * Если задание упало в ошибку, то саму ошибку можно получить при запросе Get, "/v1/task/{id}", поле Msg
  * Ключи формируются на основе хеша стурктуры. Если делать один и тот же запрос, то будет ошибка 409
